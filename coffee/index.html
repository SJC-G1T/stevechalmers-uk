<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coffee Brew Calculator â€” stevechalmers.uk</title>
  <meta name="description" content="Ratio, grind guide, and step-by-step brew instructions for espresso, V60, French Press, AeroPress, Moka Pot, and Chemex. No signup. Works offline.">
  <meta property="og:title" content="Coffee Brew Calculator">
  <meta property="og:description" content="Ratio, grind guide, and step-by-step instructions for your brew method. No signup.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://stevechalmers.uk/coffee">
  <link rel="manifest" href="/coffee/manifest.json">
  <link rel="apple-touch-icon" href="/coffee/icon-192.png">
  <meta name="theme-color" content="#08080d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Coffee">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:          #08080d;
      --surface:     #13131f;
      --surface2:    #1a1a2a;
      --border:      #1e1e2e;
      --accent:      #D4728C;
      --accent-dim:  rgba(212, 114, 140, 0.12);
      --text:        #e8e8f0;
      --muted:       #8888aa;
      --radius:      12px;
      --success:     #5db88a;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      padding-bottom: 100px;
    }

    /* â”€â”€ Nav â”€â”€ */
    nav {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-logo { font-size: 0.9rem; font-weight: 600; color: var(--muted); text-decoration: none; transition: color 0.2s; }
    .nav-logo span { color: var(--accent); }
    .nav-logo:hover { color: var(--text); }
    .nav-title { font-size: 0.9rem; font-weight: 600; color: var(--text); }

    .container { max-width: 680px; margin: 0 auto; padding: 0 24px; }

    /* â”€â”€ Hero â”€â”€ */
    .hero { padding: 44px 0 32px; text-align: center; }

    /* Animated coffee cup */
    .hero-svg { display: block; margin: 0 auto 20px; color: var(--accent); }

    @keyframes steam1 {
      0%   { transform: translateY(0)    scaleX(1);    opacity: 0.85; }
      50%  { transform: translateY(-11px) scaleX(1.12); opacity: 0.45; }
      100% { transform: translateY(-22px) scaleX(0.9);  opacity: 0;    }
    }
    @keyframes steam2 {
      0%   { transform: translateY(0)    scaleX(1);    opacity: 0.8; }
      50%  { transform: translateY(-9px)  scaleX(0.88); opacity: 0.4; }
      100% { transform: translateY(-20px) scaleX(1.1);  opacity: 0;   }
    }
    @keyframes steam3 {
      0%   { transform: translateY(0)    scaleX(1);    opacity: 0.75; }
      50%  { transform: translateY(-13px) scaleX(1.1);  opacity: 0.35; }
      100% { transform: translateY(-24px) scaleX(0.9);  opacity: 0;    }
    }
    .steam { transform-origin: bottom center; }
    .s1 { animation: steam1 2.4s ease-in-out infinite; }
    .s2 { animation: steam2 2.4s ease-in-out infinite; animation-delay: 0.55s; }
    .s3 { animation: steam3 2.4s ease-in-out infinite; animation-delay: 1.1s; }

    @media (prefers-reduced-motion: reduce) {
      .s1, .s2, .s3 { animation: none; opacity: 0.5; }
    }

    .hero h1 { font-size: 1.85rem; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 10px; }
    .hero p  { font-size: 0.97rem; color: var(--muted); }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      margin-bottom: 12px;
    }
    .card-title {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 14px;
    }

    /* â”€â”€ Method pills â”€â”€ */
    .method-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 7px;
    }
    .method-pill {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 6px;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      text-align: center;
      transition: all 0.18s;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.25;
    }
    .method-pill:hover { border-color: var(--accent); color: var(--text); }
    .method-pill.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Inputs â”€â”€ */
    .field { margin-bottom: 14px; }
    .field:last-child { margin-bottom: 0; }
    label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text); margin-bottom: 7px; }
    label .hint { font-weight: 400; color: var(--muted); margin-left: 5px; }

    input[type="number"] {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 13px 16px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text);
      appearance: none;
      -webkit-appearance: none;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="number"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
    input[type="number"]::-webkit-inner-spin-button { opacity: 0.4; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .esp-note { font-size: 0.78rem; color: var(--muted); margin-top: 8px; line-height: 1.5; }

    /* â”€â”€ Ratio display â”€â”€ */
    .ratio-display {
      background: var(--accent-dim);
      border: 1px solid rgba(212,114,140,0.28);
      border-radius: 8px;
      padding: 11px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
    }
    .ratio-label { font-size: 0.84rem; color: var(--muted); }
    .ratio-value { font-size: 1.1rem; font-weight: 700; color: var(--accent); letter-spacing: -0.02em; }

    /* â”€â”€ Grind guide â”€â”€ */
    .grind-toggle {
      display: flex;
      align-items: center;
      gap: 7px;
      background: none;
      border: none;
      font-family: inherit;
      font-size: 0.81rem;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      margin-top: 14px;
      transition: color 0.2s;
    }
    .grind-toggle:hover { color: var(--accent); }
    .grind-chevron { transition: transform 0.22s; }
    .grind-toggle.open .grind-chevron { transform: rotate(180deg); }

    .grind-body { display: none; margin-top: 13px; padding-top: 13px; border-top: 1px solid var(--border); }
    .grind-body.open { display: block; }

    .grind-setting {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--surface2);
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 0.84rem;
      color: var(--muted);
      line-height: 1.5;
    }
    .grind-setting strong { color: var(--text); font-weight: 600; }

    .subsection-title {
      font-size: 0.68rem;
      font-weight: 600;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: var(--accent);
      margin: 12px 0 8px;
    }

    .dial-row {
      display: flex;
      align-items: flex-start;
      gap: 9px;
      margin-bottom: 7px;
      font-size: 0.82rem;
      color: var(--muted);
      line-height: 1.45;
    }
    .dial-dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--accent);
      flex-shrink: 0;
      margin-top: 6px;
    }
    .dial-row strong { color: var(--text); }

    .tip-row {
      display: flex;
      align-items: flex-start;
      gap: 9px;
      margin-bottom: 6px;
      font-size: 0.82rem;
      color: var(--muted);
      line-height: 1.45;
    }
    .tip-arrow { color: var(--accent); font-weight: 700; flex-shrink: 0; }

    /* â”€â”€ Buttons â”€â”€ */
    .btn-primary {
      width: 100%;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 14px 24px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.15s;
      min-height: 52px;
    }
    .btn-primary:hover  { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary:active { transform: translateY(0); }

    .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; margin-top: 9px; }
    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 11px 12px;
      font-family: inherit;
      font-size: 0.87rem;
      font-weight: 600;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      min-height: 48px;
    }
    .btn-secondary:hover { border-color: var(--accent); background: var(--accent-dim); }
    .save-note { font-size: 0.77rem; color: var(--muted); text-align: center; margin-top: 8px; }

    /* â”€â”€ Results â”€â”€ */
    #results { display: none; }
    #results.visible { display: block; }

    .result-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 18px;
    }
    .result-method { font-size: 1.2rem; font-weight: 700; letter-spacing: -0.02em; }
    .result-meta { display: flex; gap: 9px; flex-wrap: wrap; }
    .meta-chip {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 4px 11px;
      font-size: 0.79rem;
      font-weight: 600;
      color: var(--muted);
    }
    .meta-chip span { color: var(--text); }

    .steps { display: flex; flex-direction: column; gap: 10px; }
    .step  { display: flex; gap: 13px; align-items: flex-start; }
    .step-num {
      flex-shrink: 0;
      width: 28px; height: 28px;
      background: var(--accent-dim);
      border: 1px solid rgba(212,114,140,0.28);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.76rem;
      font-weight: 700;
      color: var(--accent);
      margin-top: 2px;
    }
    .step-text { font-size: 0.92rem; color: var(--text); line-height: 1.55; padding-top: 4px; }
    .step-text strong { color: var(--accent); }

    /* â”€â”€ Install banner â”€â”€ */
    #install-banner {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 14px 18px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      z-index: 90;
      box-shadow: 0 -8px 32px rgba(0,0,0,0.4);
    }
    #install-banner.hidden { display: none; }
    .ib-icon  { font-size: 1.5rem; flex-shrink: 0; line-height: 1; padding-top: 2px; }
    .ib-text  { flex: 1; }
    .ib-text strong { display: block; font-size: 0.88rem; color: var(--text); margin-bottom: 2px; }
    .ib-text span   { font-size: 0.8rem; color: var(--muted); line-height: 1.4; display: block; }
    .ib-btn {
      background: var(--accent); color: #fff; border: none; border-radius: 7px;
      padding: 9px 14px; font-family: inherit; font-size: 0.84rem; font-weight: 600;
      cursor: pointer; white-space: nowrap; flex-shrink: 0; align-self: center;
    }
    .ib-dismiss {
      background: none; border: none; color: var(--muted); cursor: pointer;
      font-size: 1.15rem; line-height: 1; padding: 2px; flex-shrink: 0; align-self: flex-start;
    }

    /* â”€â”€ Toast â”€â”€ */
    .toast {
      position: fixed;
      bottom: 84px; left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--success);
      color: #fff;
      padding: 10px 17px;
      border-radius: 8px;
      font-size: 0.87rem;
      font-weight: 600;
      opacity: 0;
      transition: transform 0.28s, opacity 0.28s;
      pointer-events: none;
      z-index: 100;
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* â”€â”€ Back â”€â”€ */
    .back-link {
      display: inline-flex; align-items: center; gap: 6px;
      color: var(--muted); text-decoration: none;
      font-size: 0.84rem; font-weight: 500;
      margin: 26px 0 0; transition: color 0.2s;
    }
    .back-link:hover { color: var(--accent); }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 360px) {
      .method-grid { grid-template-columns: repeat(2, 1fr); }
      .row { grid-template-columns: 1fr; }
      .btn-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <nav>
    <a href="/" class="nav-logo">stevechalmers<span>.uk</span></a>
    <div class="nav-title">Coffee</div>
  </nav>

  <div class="container">

    <div class="hero">
      <!-- Animated coffee cup SVG -->
      <svg class="hero-svg" viewBox="0 0 80 90" width="96" height="96" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <!-- Steam (animated) -->
        <path class="steam s1" d="M28 30 C26 24 30 20 28 14" stroke-width="2.2" opacity="0.85"/>
        <path class="steam s2" d="M40 26 C38 20 42 16 40 10" stroke-width="2.2" opacity="0.8"/>
        <path class="steam s3" d="M52 30 C50 24 54 20 52 14" stroke-width="2.2" opacity="0.75"/>
        <!-- Cup body -->
        <path d="M16 38 L20 72 Q20 77 25 77 L55 77 Q60 77 60 72 L64 38 Z" stroke-width="2.2"/>
        <!-- Handle -->
        <path d="M64 48 Q76 48 76 58 Q76 68 64 68" stroke-width="2.2"/>
        <!-- Rim line -->
        <line x1="16" y1="38" x2="64" y2="38" stroke-width="2.2"/>
        <!-- Saucer -->
        <ellipse cx="40" cy="81" rx="28" ry="4.5" stroke-width="2"/>
      </svg>
      <h1>Coffee Brew Calculator</h1>
      <p>Pick your method. Get the ratio, grind guide, and exact steps.</p>
    </div>

    <!-- Method pills -->
    <div class="card">
      <div class="card-title">Method</div>
      <div class="method-grid" id="methodGrid">
        <button class="method-pill active" data-method="espresso">Espresso</button>
        <button class="method-pill" data-method="v60">V60</button>
        <button class="method-pill" data-method="french">French Press</button>
        <button class="method-pill" data-method="aeropress">AeroPress</button>
        <button class="method-pill" data-method="moka">Moka Pot</button>
        <button class="method-pill" data-method="chemex">Chemex</button>
      </div>
    </div>

    <!-- Inputs -->
    <div class="card">
      <div class="card-title" id="inputsTitle">Your shot</div>

      <div id="filterInputs" style="display:none;">
        <div class="row">
          <div class="field">
            <label>Coffee <span class="hint">grams</span></label>
            <input type="number" id="coffee" min="1" max="500" placeholder="20" inputmode="decimal">
          </div>
          <div class="field">
            <label>Water <span class="hint">ml</span></label>
            <input type="number" id="water" min="1" max="2000" placeholder="300" inputmode="decimal">
          </div>
        </div>
      </div>

      <div id="espressoInputs">
        <div class="row">
          <div class="field">
            <label>Dose <span class="hint">grams in</span></label>
            <input type="number" id="dose" min="1" max="50" placeholder="18" inputmode="decimal">
          </div>
          <div class="field">
            <label>Yield <span class="hint">grams out</span></label>
            <input type="number" id="espYield" min="1" max="200" placeholder="36" inputmode="decimal">
          </div>
        </div>
        <p class="esp-note">Place your cup on the scale before pulling. <strong>Standard double: 18g in â†’ 36g out (1:2 ratio), 25â€“30s.</strong> Prefer a longer, brighter shot? Try 18g in â†’ 54g out (1:3) â€” still great, just lighter in body. Avoid going much beyond 1:3 or it starts tasting thin.</p>
      </div>

      <div class="ratio-display" id="ratioDisplay" style="display:none;">
        <span class="ratio-label">Ratio</span>
        <span class="ratio-value" id="ratioValue">1:2</span>
      </div>

      <!-- Grind guide -->
      <button class="grind-toggle" id="grindToggle" onclick="toggleGrind()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M2 12h3M19 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg>
        Grind guide &amp; tips
        <svg class="grind-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6,9 12,15 18,9"/></svg>
      </button>
      <div class="grind-body" id="grindBody"></div>
    </div>

    <!-- Actions -->
    <div class="card" style="padding:18px;">
      <button class="btn-primary" onclick="calculate()">Calculate brew</button>
      <div class="btn-row">
        <button class="btn-secondary" onclick="saveSettings()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
          Save settings
        </button>
        <button class="btn-secondary" id="shareBtn" onclick="share()" style="display:none;">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
          Share
        </button>
      </div>
      <div class="save-note" id="saveNote" style="display:none;">Settings saved â€” pre-fills on next visit</div>
    </div>

    <!-- Results -->
    <div class="card" id="results">
      <div class="result-header">
        <div class="result-method" id="resultMethod"></div>
        <div class="result-meta">
          <div class="meta-chip">Ratio: <span id="resultRatio"></span></div>
          <div class="meta-chip">Time: <span id="resultTime"></span></div>
        </div>
      </div>
      <div class="steps" id="stepsContainer"></div>
    </div>

    <a href="/" class="back-link">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15,18 9,12 15,6"/></svg>
      All apps
    </a>
  </div>

  <!-- PWA install banner -->
  <div id="install-banner" class="hidden">
    <div class="ib-icon">ğŸ“²</div>
    <div class="ib-text">
      <strong>Add to Home Screen</strong>
      <span id="ib-instructions"></span>
    </div>
    <button class="ib-btn" id="ib-btn" onclick="triggerInstall()">Install</button>
    <button class="ib-dismiss" onclick="dismissBanner()" aria-label="Dismiss">âœ•</button>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  // â”€â”€ Brew data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const BREWS = {
    espresso: {
      name: 'Espresso',
      isEspresso: true,
      brewTime: '25â€“30s',
      grind: {
        desc: 'Very fine â€” finer than any other method. Think powdered sugar. Even small adjustments make a big difference.',
        dialSteps: [
          ['Shot runs fast (under 20s) or pours pale and watery', 'Grind finer â€” one small step, then retry. Fast + watery = under-extracted'],
          ['Shot runs in 25â€“30s, tastes balanced', "You're dialled in â€” note your grind setting and stick with it"],
          ['Shot runs slow (over 35s) or barely drips', 'Grind coarser â€” one small step. If very slow, also check your tamp pressure'],
          ['Tastes sour, sharp, or hollow', 'Under-extracted: grind finer, or increase dose by 0.5â€“1g'],
          ['Tastes bitter, harsh, or ashy', 'Over-extracted: grind coarser, or reduce your target yield slightly'],
          ['Tastes thin and weak despite correct time', 'Increase dose (try 19â€“20g) or reduce target yield to tighten the ratio'],
        ],
        tips: [
          'For a double espresso, start with 18g in and aim for 36g out (1:2). If you prefer a brighter, lighter-bodied shot, try 18g in â†’ 45â€“54g out â€” still well within modern specialty practice',
          'Fresh beans make the biggest difference â€” a coffee subscription (beans roasted to order) is immediately noticeable vs. supermarket pre-ground',
          'Keep beans in an airtight container at room temperature, away from light',
          'Dial in with a single-origin or espresso-designed blend â€” flavoured beans make it much harder to taste what\'s going on',
          'A cheap scale is your best investment: weigh dose and yield in grams, not by eye or volume',
          'Consistency is everything: same dose, same tamp pressure, same grind setting = repeatable shots',
          'When a shot tastes off, change only one variable at a time â€” grind first, then dose, then yield',
        ],
      },
      getSteps(dose, yld) {
        const ratio = (yld / dose).toFixed(1);
        const ratioNum = yld / dose;
        let styleNote = '';
        if (ratioNum <= 2.2) {
          styleNote = 'This is a classic ristretto-to-double range â€” rich, full-bodied, concentrated.';
        } else if (ratioNum <= 2.8) {
          styleNote = 'This is a longer double / modern specialty style â€” bright, slightly lighter body.';
        } else {
          styleNote = 'This is in lungo territory â€” very light body. Great for some beans, but watch for thinness.';
        }
        return [
          `Purge your group head with a short burst of hot water to clear old grounds and stabilise temperature.`,
          `Weigh <strong>${dose}g</strong> of freshly ground coffee into your portafilter basket. Grind as close to pulling as possible â€” pre-ground coffee stales quickly and extracts unevenly.`,
          `Distribute the grounds evenly. Tap the portafilter gently and use a finger or distribution tool to level the puck. Even distribution prevents channelling (water finding an easy path through).`,
          `Tamp firmly and level. Apply steady downward pressure â€” aim for a flat, even puck. Don't twist or tilt the tamper.`,
          `Place your cup on the scale and tare to zero. Lock the portafilter in and start your timer immediately. Begin extraction.`,
          `Target yield: <strong>${yld}g</strong> in the cup â€” stop when the scale hits that weight. Ratio 1:${ratio}. ${styleNote} Aim for <strong>25â€“30 seconds</strong> total extraction time.`,
          `If it ran fast (under 20s) or slow (over 35s), adjust your grind by one small step and retry. Taste before adjusting â€” use the grind guide below to diagnose. One change at a time.`,
        ];
      }
    },
    v60: {
      name: 'V60 Pour Over',
      defaultRatio: 15,
      brewTime: '3:00â€“3:30',
      grind: { desc: 'Medium-fine â€” like table salt. Coarser than espresso, finer than paper filter coffee typically needs.' },
      getSteps(coffee, water) {
        const bloom = Math.round(coffee * 2);
        const p1    = Math.round(water * 0.4);
        const p2    = Math.round(water * 0.3);
        const p3    = water - bloom - p1 - p2;
        return [
          `Rinse your V60 filter with hot water. Discard the rinse water â€” this removes papery taste and warms the dripper.`,
          `Add <strong>${coffee}g</strong> of medium-fine ground coffee. Give it a gentle shake to level.`,
          `Start your timer. Pour <strong>${bloom}ml</strong> of water at 93Â°C / 200Â°F evenly over the grounds. Wait 30 seconds for the bloom.`,
          `At 0:30, pour <strong>${p1}ml</strong> in a slow spiral from the centre outward. Keep water level consistent.`,
          `At 1:00, add <strong>${p2}ml</strong> continuing the spiral pour.`,
          `At 1:30, add the remaining <strong>${p3}ml</strong> to reach ${water}ml total. Pour slowly.`,
          `Allow the coffee to drain fully. Total draw-down should finish by 3:00â€“3:30.`,
        ];
      }
    },
    french: {
      name: 'French Press',
      defaultRatio: 15,
      brewTime: '4:00',
      grind: { desc: 'Coarse â€” like sea salt or coarse breadcrumbs. Never go finer or pressing becomes difficult and the coffee turns bitter.' },
      getSteps(coffee, water) {
        return [
          `Preheat your French Press with hot water. Discard and dry.`,
          `Add <strong>${coffee}g</strong> of coarsely ground coffee. Coarse grind is essential â€” fine grind makes it bitter and nearly impossible to press.`,
          `Start your timer. Pour <strong>${water}ml</strong> of water at 93Â°C / 200Â°F over the grounds. Make sure all coffee is saturated.`,
          `Give it a gentle stir to ensure full saturation. Place the lid on (plunger up) â€” do not press yet.`,
          `Steep for <strong>4 minutes</strong>. Don't rush this.`,
          `Slowly press the plunger down with steady, even pressure. If it resists strongly, your grind may be too fine.`,
          `Pour immediately. Don't leave coffee sitting in the press or it will over-extract and turn bitter.`,
        ];
      }
    },
    aeropress: {
      name: 'AeroPress',
      defaultRatio: 12,
      brewTime: '1:30â€“2:00',
      grind: { desc: 'Medium-fine to medium â€” flexible and forgiving. Start at medium and adjust to taste. Hard to get wrong.' },
      getSteps(coffee, water) {
        const c = Math.min(coffee, 30);
        const w = Math.round(c * (water / coffee));
        return [
          `Set up AeroPress inverted (plunger in, chamber upside down). This gives more control over steep time.`,
          `Rinse a paper filter in the filter cap with hot water. Set aside.`,
          `Add <strong>${c}g</strong> of ground coffee. AeroPress works best between 15â€“30g.`,
          `Start timer. Add <strong>${w}ml</strong> of water at 85â€“90Â°C / 185â€“195Â°F â€” slightly cooler than other methods.`,
          `Stir 10 times to ensure full saturation. Steep for <strong>1 minute</strong>.`,
          `Attach the filter cap. Carefully flip onto your mug. Press slowly and steadily â€” aim for 30 seconds.`,
          `Stop when you hear a hiss. Dilute with hot water to taste if needed.`,
        ];
      }
    },
    moka: {
      name: 'Moka Pot',
      defaultRatio: 7,
      brewTime: '5:00â€“7:00',
      grind: { desc: 'Fine â€” finer than table salt, but not as fine as espresso. Avoid powder-fine or it will block the filter.' },
      getSteps(coffee, water) {
        return [
          `Fill the bottom chamber with <strong>${water}ml</strong> of hot (not boiling) water up to the pressure valve. Pre-heating prevents burning the coffee during heating.`,
          `Fill the filter basket with <strong>${coffee}g</strong> of finely ground coffee. Level the surface gently â€” do not tamp.`,
          `Screw the top and bottom chambers together firmly.`,
          `Place on medium-low heat. Keep the lid open so you can watch extraction.`,
          `Coffee will slowly flow into the upper chamber. When you hear a gurgling sound and see pale, bubbly coffee emerging, remove from heat immediately.`,
          `Run the bottom of the pot under cold water to stop extraction and prevent a bitter taste.`,
          `Pour and serve immediately. Moka coffee is strong and concentrated â€” add hot water or milk to taste.`,
        ];
      }
    },
    chemex: {
      name: 'Chemex',
      defaultRatio: 16,
      brewTime: '4:00â€“5:00',
      grind: { desc: 'Medium-coarse â€” coarser than V60, like rough sand. The thicker Chemex filter needs a coarser grind than other pour-overs.' },
      getSteps(coffee, water) {
        const bloom = Math.round(coffee * 2.5);
        const p1    = Math.round(water * 0.35);
        const p2    = Math.round(water * 0.35);
        const p3    = water - bloom - p1 - p2;
        return [
          `Place the Chemex filter (three-layer side toward the spout). Rinse thoroughly with hot water â€” Chemex filters are thick and need a proper rinse. Discard rinse water.`,
          `Add <strong>${coffee}g</strong> of medium-coarse ground coffee.`,
          `Start timer. Bloom: pour <strong>${bloom}ml</strong> of water at 93Â°C / 200Â°F. Wait 45 seconds â€” Chemex needs longer to bloom.`,
          `At 0:45, pour <strong>${p1}ml</strong> in a steady spiral from the centre outward.`,
          `At 2:00, add <strong>${p2}ml</strong> continuing the slow pour.`,
          `At 3:15, add the remaining <strong>${p3}ml</strong>. Total: ${water}ml.`,
          `Allow full draw-down. 4â€“5 minutes total. The thick filter delivers a cleaner, brighter cup than other pour-overs.`,
        ];
      }
    },
  };

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let currentMethod = 'espresso';
  let lastResult    = null;
  let deferredPrompt = null;

  // â”€â”€ Method pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('methodGrid').addEventListener('click', e => {
    const pill = e.target.closest('.method-pill');
    if (!pill) return;
    document.querySelectorAll('.method-pill').forEach(p => p.classList.remove('active'));
    pill.classList.add('active');
    currentMethod = pill.dataset.method;
    switchMethod();
  });

  function switchMethod() {
    const brew = BREWS[currentMethod];
    document.getElementById('inputsTitle').textContent     = brew.isEspresso ? 'Your shot' : 'Your brew';
    document.getElementById('espressoInputs').style.display = brew.isEspresso ? 'block' : 'none';
    document.getElementById('filterInputs').style.display   = brew.isEspresso ? 'none'  : 'block';
    updateRatioDisplay();
    renderGrindBody();
    // Collapse grind guide on switch
    document.getElementById('grindToggle').classList.remove('open');
    document.getElementById('grindBody').classList.remove('open');
  }

  // â”€â”€ Ratio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateRatioDisplay() {
    const brew = BREWS[currentMethod];
    let ratio = null;
    if (brew.isEspresso) {
      const d = parseFloat(document.getElementById('dose').value);
      const y = parseFloat(document.getElementById('espYield').value);
      if (d > 0 && y > 0) ratio = (y / d).toFixed(1);
    } else {
      const c = parseFloat(document.getElementById('coffee').value);
      const w = parseFloat(document.getElementById('water').value);
      if (c > 0 && w > 0) ratio = (w / c).toFixed(1);
    }
    const el = document.getElementById('ratioDisplay');
    if (ratio) { document.getElementById('ratioValue').textContent = `1:${ratio}`; el.style.display = 'flex'; }
    else        { el.style.display = 'none'; }
  }

  ['coffee','water','dose','espYield'].forEach(id =>
    document.getElementById(id).addEventListener('input', updateRatioDisplay)
  );

  // â”€â”€ Grind guide â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleGrind() {
    document.getElementById('grindToggle').classList.toggle('open');
    document.getElementById('grindBody').classList.toggle('open');
  }

  function renderGrindBody() {
    const g = BREWS[currentMethod].grind;
    let h = `<div class="grind-setting">âš™ï¸ &nbsp;<span><strong>Grind size:</strong> ${g.desc}</span></div>`;

    if (BREWS[currentMethod].isEspresso) {
      h += `<div class="subsection-title">Dialling in â€” what to adjust</div>`;
      g.dialSteps.forEach(([cue, action]) => {
        h += `<div class="dial-row"><div class="dial-dot"></div><div><strong>${cue}</strong> â†’ ${action}</div></div>`;
      });
      h += `<div class="subsection-title" style="margin-top:14px;">Top tips</div>`;
      g.tips.forEach(tip => {
        h += `<div class="tip-row"><span class="tip-arrow">â†’</span><span>${tip}</span></div>`;
      });
    }
    document.getElementById('grindBody').innerHTML = h;
  }

  // â”€â”€ Calculate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function calculate() {
    const brew = BREWS[currentMethod];
    let steps, ratio;

    if (brew.isEspresso) {
      const dose = parseFloat(document.getElementById('dose').value);
      const yld  = parseFloat(document.getElementById('espYield').value);
      if (!dose || !yld || dose <= 0 || yld <= 0) { showToast('Enter dose and yield first', '#D4728C'); return; }
      steps = brew.getSteps(dose, yld);
      ratio = (yld / dose).toFixed(1);
      lastResult = { method: currentMethod, dose, yld };
    } else {
      const coffee = parseFloat(document.getElementById('coffee').value);
      const water  = parseFloat(document.getElementById('water').value);
      if (!coffee || !water || coffee <= 0 || water <= 0) { showToast('Enter coffee and water first', '#D4728C'); return; }
      steps = brew.getSteps(coffee, water);
      ratio = (water / coffee).toFixed(1);
      lastResult = { method: currentMethod, coffee, water };
    }

    document.getElementById('resultMethod').textContent = brew.name;
    document.getElementById('resultRatio').textContent  = `1:${ratio}`;
    document.getElementById('resultTime').textContent   = brew.brewTime;

    const sc = document.getElementById('stepsContainer');
    sc.innerHTML = '';
    steps.forEach((text, i) => {
      sc.innerHTML += `<div class="step"><div class="step-num">${i+1}</div><div class="step-text">${text}</div></div>`;
    });

    document.getElementById('results').classList.add('visible');
    document.getElementById('shareBtn').style.display = 'flex';
    setTimeout(() => document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
  }

  // â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveSettings() {
    const brew = BREWS[currentMethod];
    const data = { method: currentMethod };
    if (brew.isEspresso) {
      data.dose = document.getElementById('dose').value;
      data.yld  = document.getElementById('espYield').value;
    } else {
      data.coffee = document.getElementById('coffee').value;
      data.water  = document.getElementById('water').value;
    }
    localStorage.setItem('coffee_saved', JSON.stringify(data));
    document.getElementById('saveNote').style.display = 'block';
    showToast('Settings saved');
  }

  // â”€â”€ Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function share() {
    if (!lastResult) return;
    const brew = BREWS[lastResult.method];
    let text;
    if (lastResult.method === 'espresso') {
      const ratio = (lastResult.yld / lastResult.dose).toFixed(1);
      text = `My espresso: ${lastResult.dose}g in â†’ ${lastResult.yld}g out (1:${ratio}), target 25â€“30s â€” stevechalmers.uk/coffee`;
    } else {
      const ratio = (lastResult.water / lastResult.coffee).toFixed(1);
      text = `My ${brew.name}: 1:${ratio} (${lastResult.coffee}g coffee / ${lastResult.water}ml water), ${brew.brewTime} â€” stevechalmers.uk/coffee`;
    }
    if (navigator.share) {
      navigator.share({ text }).catch(() => copyToClipboard(text));
    } else {
      copyToClipboard(text);
    }
  }

  function copyToClipboard(text) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard'));
    } else {
      const ta = Object.assign(document.createElement('textarea'), { value: text });
      ta.style.cssText = 'position:fixed;opacity:0';
      document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      showToast('Copied to clipboard');
    }
  }

  // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showToast(msg, color) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.background = color || 'var(--success)';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  // â”€â”€ PWA Install â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const isIOS   = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const inApp   = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  const wasDism = localStorage.getItem('pwa_dismissed');

  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    if (!wasDism && !inApp) showBanner('android');
  });

  if (isIOS && !inApp && !wasDism) setTimeout(() => showBanner('ios'), 1800);

  function showBanner(type) {
    const instr = document.getElementById('ib-instructions');
    const btn   = document.getElementById('ib-btn');
    if (type === 'ios') {
      instr.textContent = 'Tap the Share button, then "Add to Home Screen". Works offline â€” no App Store needed.';
      btn.style.display = 'none';
    } else {
      instr.textContent = 'Install to your home screen. Works offline â€” no App Store needed.';
      btn.style.display = 'block';
    }
    document.getElementById('install-banner').classList.remove('hidden');
  }

  function triggerInstall() {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => { deferredPrompt = null; dismissBanner(); });
  }

  function dismissBanner() {
    document.getElementById('install-banner').classList.add('hidden');
    localStorage.setItem('pwa_dismissed', '1');
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('coffee_saved');
    if (saved) {
      try {
        const d = JSON.parse(saved);
        if (d.method && BREWS[d.method]) {
          currentMethod = d.method;
          document.querySelectorAll('.method-pill').forEach(p =>
            p.classList.toggle('active', p.dataset.method === d.method)
          );
        }
        if (d.dose)   document.getElementById('dose').value     = d.dose;
        if (d.yld)    document.getElementById('espYield').value = d.yld;
        if (d.coffee) document.getElementById('coffee').value   = d.coffee;
        if (d.water)  document.getElementById('water').value    = d.water;
      } catch(e) {}
    }
    switchMethod();
  });

  // â”€â”€ Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/coffee/sw.js').catch(() => {});
  }
  </script>

</body>
</html>
